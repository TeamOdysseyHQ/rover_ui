<script>
	import { 
		Bot, Route, Archive, Download, Drill, ArrowDownUp, TestTubes, 
		RotateCcw, RotateCw, BatteryCharging, Zap, Thermometer, Antenna,
		ScanLine, Aperture, Maximize, FileDown
	} from 'lucide-svelte';
	import { dispatchCommand } from '$lib/stores/commandStore';
	import Joystick from '$lib/components/Joystick.svelte';
	import ToggleSwitch from '$lib/components/ToggleSwitch.svelte';
	import Modal from '$lib/components/Modal.svelte';
	
	let showAutoModal = false;
	let ackermanMode = true;
	let independentMode = false;
	let drillSpeed = 50;
	let testTubeSlot = 3;
	
	function handleJoystickMove(event) {
		dispatchCommand('JOYSTICK_MOVE', { x: event.detail.x, y: event.detail.y });
	}
	
	function toggleSteeringMode(mode) {
		if (mode === 'ackerman') {
			ackermanMode = !ackermanMode;
			dispatchCommand('STEERING_MODE', { mode: 'ackerman', enabled: ackermanMode });
		} else {
			independentMode = !independentMode;
			dispatchCommand('STEERING_MODE', { mode: 'independent', enabled: independentMode });
		}
	}
	
	function handleDrillSpeed(value) {
		drillSpeed = value;
		dispatchCommand('DRILL_SPEED', { speed: value });
	}
	
	function rotateTestTube(direction) {
		testTubeSlot = direction === 'left' 
			? Math.max(1, testTubeSlot - 1)
			: Math.min(6, testTubeSlot + 1);
		dispatchCommand('TEST_TUBE_ROTATE', { slot: testTubeSlot, direction });
	}
	
	function initiateAutonomous(lat, lon) {
		dispatchCommand('AUTONOMOUS_MODE', { latitude: lat, longitude: lon });
		showAutoModal = false;
	}
	
	let siteReason = '';
	
	const cameras = [
		{ id: 'CAM_FRONT_HAZ', label: 'CAM_FRONT_HAZ', checked: true },
		{ id: 'CAM_REAR_HAZ', label: 'CAM_REAR_HAZ', checked: false },
		{ id: 'CAM_SCIENCE_ARM', label: 'CAM_SCIENCE_ARM', checked: false },
		{ id: 'CAM_MAST_NAV', label: 'CAM_MAST_NAV', checked: false },
		{ id: 'MICROSCOPE_IMAGER', label: 'MICROSCOPE_IMAGER', checked: false }
	];
	
	const wheels = ['Front Left', 'Front Right', 'Rear Left', 'Rear Right'];
	let wheelSpeeds = { 'Front Left': 100, 'Front Right': 100, 'Rear Left': 100, 'Rear Right': 100 };
	let wheelDirections = { 'Front Left': 0, 'Front Right': 0, 'Rear Left': 0, 'Rear Right': 0 };

</script>

<div class="p-4 sm:p-6 lg:p-8">
	<div class="max-w-screen-2xl mx-auto">
		<!-- Header -->
		<header class="flex justify-between items-center mb-6">
			<div>
				<h1 class="text-2xl font-bold text-white">Anveshak Rover Command Center</h1>
				<p class="text-sm text-slate-400">
					STATUS: <span class="text-green-400 font-semibold">NOMINAL</span> | IN | OCT 19 2025, 12:40 IST
				</p>
			</div>
			<div class="flex items-center gap-4">
				<div class="text-right">
					<p class="font-semibold text-white">Client</p>
				</div>
				<img src="https://placehold.co/40x40/0ea5e9/ffffff?text=C" alt="User Avatar" class="rounded-full">
			</div>
		</header>

		<!-- Main Content Grid -->
		<main class="grid grid-cols-1 lg:grid-cols-3 xl:grid-cols-4 gap-6">
			
			<!-- Column 1: Primary Driving & Navigation -->
			<div class="space-y-6 xl:col-span-1">
				<div class="card">
					<div class="p-4 border-b border-slate-700">
						<h2 class="font-semibold text-lg text-white">Driving Controls</h2>
					</div>
					<div class="p-4 flex justify-between items-center">
						<div>
							<h3 class="font-semibold text-white">Mode: Manual</h3>
							<p class="text-sm text-slate-400">Ready for input</p>
						</div>
						<button class="btn btn-primary" on:click={() => showAutoModal = true}>
							<Bot class="w-4 h-4 mr-2" />Go Autonomous
						</button>
					</div>
					<div class="p-4 flex justify-around items-center">
						<Joystick on:move={handleJoystickMove} />
						<div>
							<h3 class="font-semibold mb-2 text-center text-white">Steering</h3>
							<div class="flex items-center gap-2 mb-2">
								<label class="text-sm">Ackerman</label>
								<ToggleSwitch 
									checked={ackermanMode}
									on:change={() => toggleSteeringMode('ackerman')}
								/>
							</div>
							<div class="flex items-center gap-2">
								<label class="text-sm">Independent</label>
								<ToggleSwitch 
									checked={independentMode}
									on:change={() => toggleSteeringMode('independent')}
								/>
							</div>
						</div>
					</div>
				</div>

				<div class="card">
					<div class="p-4 border-b border-slate-700">
						<h2 class="font-semibold text-lg text-white">Navigation & Journey</h2>
					</div>
					<div class="p-4 space-y-3 text-sm">
						<p class="flex justify-between"><strong>GPS Coordinates:</strong> <span>16.5062° N, 80.6480° E</span></p>
						<p class="flex justify-between"><strong>Encoder Path:</strong> <span class="text-sky-400">Displaying...</span></p>
						<p class="flex justify-between"><strong>Distance to Target:</strong> <span class="text-amber-400">N/A</span></p>
						<p class="flex justify-between"><strong>Obstacles Detected:</strong> <span class="text-red-400">None</span></p>
					</div>
					<div class="p-4 border-t border-slate-700">
						<button 
							class="btn btn-secondary w-full"
							on:click={() => dispatchCommand('SCHEDULE_JOURNEY')}
						>
							<Route class="w-4 h-4 mr-2" />Schedule Journey
						</button>
					</div>
				</div>
				
				<div class="card">
					<div class="p-4 border-b border-slate-700">
						<h2 class="font-semibold text-lg text-white">Robotic Arm</h2>
					</div>
					<div class="p-4 space-y-3">
						<button 
							class="btn btn-primary w-full"
							on:click={() => dispatchCommand('ARM_DROP_STORAGE')}
						>
							<Archive class="w-4 h-4 mr-2" />Drop in Storage Box
						</button>
						<button 
							class="btn btn-secondary w-full"
							on:click={() => dispatchCommand('ARM_DROP_OUTSIDE')}
						>
							<Download class="w-4 h-4 mr-2" />Drop Outside Rover
						</button>
					</div>
				</div>
			</div>

			<!-- Column 2: Science Operations -->
			<div class="space-y-6 xl:col-span-1">
				<div class="card">
					<div class="p-4 border-b border-slate-700">
						<h2 class="font-semibold text-lg text-white">Science Operations</h2>
					</div>
					<div class="p-4 space-y-6">
						<!-- Drill Controls -->
						<div class="space-y-3">
							<h3 class="font-semibold text-white flex items-center gap-2">
								<Drill class="text-sky-400" />Drill System
							</h3>
							<div class="flex justify-between items-center">
								<span>Drill Status</span>
								<ToggleSwitch 
									on:change={(e) => dispatchCommand('DRILL_TOGGLE', { enabled: e.detail })}
								/>
							</div>
							<label class="block text-sm font-medium">
								Drill Speed: <span>{drillSpeed}%</span>
							</label>
							<input 
								type="range" 
								min="0" 
								max="100" 
								bind:value={drillSpeed}
								on:input={(e) => handleDrillSpeed(e.target.value)}
								class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer"
							>
						</div>
						<!-- Collection -->
						<div class="space-y-3">
							<h3 class="font-semibold text-white flex items-center gap-2">
								<ArrowDownUp class="text-sky-400" />Collection System
							</h3>
							<div class="flex justify-between items-center">
								<span>Linear Actuator</span>
								<ToggleSwitch 
									on:change={(e) => dispatchCommand('LINEAR_ACTUATOR', { enabled: e.detail })}
								/>
							</div>
							<div class="flex justify-between items-center">
								<span>Suction System</span>
								<ToggleSwitch 
									on:change={(e) => dispatchCommand('SUCTION_SYSTEM', { enabled: e.detail })}
								/>
							</div>
							<div class="flex justify-between items-center">
								<span>Water Sprinkler</span>
								<button 
									class="btn btn-secondary text-sm"
									on:click={() => dispatchCommand('WATER_DISPENSE')}
								>
									Dispense
								</button>
							</div>
						</div>
						<!-- Sample Carousel -->
						<div class="space-y-3">
							<h3 class="font-semibold text-white flex items-center gap-2">
								<TestTubes class="text-sky-400" />Sample Analysis
							</h3>
							<div class="flex justify-between items-center">
								<span>Test Tube Module</span>
								<div class="flex gap-2">
									<button class="btn btn-secondary" on:click={() => rotateTestTube('left')}>
										<RotateCcw />
									</button>
									<span class="p-2 bg-slate-700 rounded-md w-16 text-center font-mono">
										SLOT {testTubeSlot}
									</span>
									<button class="btn btn-secondary" on:click={() => rotateTestTube('right')}>
										<RotateCw />
									</button>
								</div>
							</div>
							<div class="flex items-end gap-2">
								<div class="flex-grow">
									<label class="text-xs font-medium">Reason for choosing site:</label>
									<input 
										bind:value={siteReason}
										type="text" 
										class="w-full mt-1 bg-slate-700 border border-slate-600 rounded-md p-2 text-white" 
										placeholder="e.g., High mineral concentration..."
									>
								</div>
								<button 
									class="btn btn-primary"
									on:click={() => dispatchCommand('LOG_SITE_REASON', { reason: siteReason, slot: testTubeSlot })}
								>
									Log
								</button>
							</div>
						</div>
					</div>
				</div>
				<div class="card">
					<div class="p-4 border-b border-slate-700">
						<h2 class="font-semibold text-lg text-white">Soil & Chemical Analysis</h2>
					</div>
					<div class="p-4 space-y-4">
						<button 
							class="btn btn-primary w-full mb-2"
							on:click={() => dispatchCommand('PREDICT_SOIL_TYPE')}
						>
							Predict Soil Type (from Microscope)
						</button>
						<input 
							type="text" 
							class="w-full bg-slate-700 border border-slate-600 rounded-md p-2 text-white" 
							placeholder="Manual Soil Entry..."
						>
						<div class="p-4 bg-slate-900 rounded-lg flex items-center justify-center gap-4">
							<div class="w-16 h-16 rounded-full bg-gradient-to-br from-purple-400 to-indigo-600 border-4 border-slate-700"></div>
							<p class="font-semibold text-lg">Test: <span class="text-white">Perchlorate+</span></p>
						</div>
					</div>
				</div>
			</div>

			<!-- Column 3: System Health & Data -->
			<div class="space-y-6 xl:col-span-1">
				<div class="card">
					<div class="p-4 border-b border-slate-700">
						<h2 class="font-semibold text-lg text-white">System Health</h2>
					</div>
					<div class="p-4 grid grid-cols-2 gap-4">
						<!-- Battery -->
						<div class="flex flex-col items-center">
							<h3 class="font-semibold text-white mb-2 flex items-center gap-2">
								<BatteryCharging class="text-green-400" />Battery
							</h3>
							<div class="relative w-24 h-24">
								<svg class="w-full h-full -rotate-90" viewBox="0 0 36 36">
									<circle class="text-slate-700" cx="18" cy="18" r="15.9155" fill="none" stroke="currentColor" stroke-width="3"></circle>
									<circle class="text-green-500" cx="18" cy="18" r="15.9155" fill="none" stroke="currentColor" stroke-width="3" stroke-dasharray="85, 100" stroke-linecap="round"></circle>
								</svg>
								<div class="absolute inset-0 flex flex-col items-center justify-center">
									<span class="text-2xl font-bold text-white">85%</span>
								</div>
							</div>
							<p class="text-xs text-slate-400 mt-2">Health: 98%</p>
						</div>
						<!-- Power -->
						<div class="flex flex-col items-center">
							<h3 class="font-semibold text-white mb-2 flex items-center gap-2">
								<Zap class="text-amber-400" />Power
							</h3>
							<div class="relative w-24 h-24">
								<svg class="w-full h-full -rotate-90" viewBox="0 0 36 36">
									<circle class="text-slate-700" cx="18" cy="18" r="15.9155" fill="none" stroke="currentColor" stroke-width="3"></circle>
									<circle class="text-amber-500" cx="18" cy="18" r="15.9155" fill="none" stroke="currentColor" stroke-width="3" stroke-dasharray="75, 100" stroke-linecap="round"></circle>
								</svg>
								<div class="absolute inset-0 flex flex-col items-center justify-center">
									<span class="text-2xl font-bold text-white">120<span class="text-lg">W</span></span>
								</div>
							</div>
							<p class="text-xs text-slate-400 mt-2">Consumption</p>
						</div>
					</div>
					<div class="p-4 border-t border-slate-700">
						<h3 class="font-semibold text-white mb-2 flex items-center gap-2">
							<Thermometer class="text-red-400" />Heat Status
						</h3>
						<ul class="text-xs space-y-2 text-slate-400">
							<li class="flex justify-between"><span>Ambient Temp</span><span class="font-semibold text-white">-15° C</span></li>
							<li class="flex justify-between"><span>Battery Core</span><span class="text-amber-400">25° C</span></li>
							<li class="flex justify-between"><span>CPU Avionics</span><span class="text-green-400">42° C</span></li>
						</ul>
					</div>
				</div>
				<div class="card">
					<div class="p-4 border-b border-slate-700">
						<h2 class="font-semibold text-lg text-white">Data & Comms</h2>
					</div>
					<div class="p-4 space-y-4">
						<div class="flex justify-between items-center">
							<h3 class="font-semibold text-white flex items-center gap-2">
								<Antenna class="text-sky-400" />TX/RX Rate
							</h3>
							<span class="text-xl font-bold text-sky-400">2 Mbps</span>
						</div>
						<div class="flex justify-between items-center">
							<h3 class="font-semibold text-white">Antenna Alignment</h3>
							<div class="flex items-center gap-2">
								<label class="text-sm">Auto</label>
								<ToggleSwitch 
									checked={true}
									on:change={(e) => dispatchCommand('ANTENNA_AUTO', { enabled: e.detail })}
								/>
							</div>
						</div>
						<button 
							class="btn btn-secondary w-full"
							on:click={() => dispatchCommand('SCAN_FREQUENCIES')}
						>
							<ScanLine class="w-4 h-4 mr-2" />Scan Frequencies
						</button>
					</div>
				</div>
				<div class="card">
					<div class="p-4 border-b border-slate-700">
						<h2 class="font-semibold text-lg text-white">Imaging & Reports</h2>
					</div>
					<div class="p-4 space-y-3">
						<button 
							class="btn btn-secondary w-full"
							on:click={() => dispatchCommand('TAKE_SCREENSHOT')}
						>
							<Aperture class="w-4 h-4 mr-2" />Take Screenshot
						</button>
						<button 
							class="btn btn-secondary w-full"
							on:click={() => dispatchCommand('CAPTURE_PANORAMIC')}
						>
							<Maximize class="w-4 h-4 mr-2" />Capture Panoramic
						</button>
						<button 
							class="btn btn-secondary w-full mt-4 border-t border-slate-700 pt-3"
							on:click={() => dispatchCommand('GENERATE_REPORT')}
						>
							<FileDown class="w-4 h-4 mr-2" />Generate Full Report (PDF)
						</button>
					</div>
				</div>
			</div>

			<!-- Column 4: Transmission & Wheel Control -->
			<div class="space-y-6 xl:col-span-1">
				<div class="card">
					<div class="p-4 border-b border-slate-700 flex justify-between items-center">
						<h2 class="font-semibold text-lg text-white">Data Transmission</h2>
					</div>
					<div class="p-4 space-y-3">
						{#each cameras as camera}
							<div class="flex items-center justify-between p-2 bg-slate-900 rounded-lg">
								<span class="font-medium text-sm">{camera.label}</span>
								<ToggleSwitch 
									checked={camera.checked}
									on:change={(e) => dispatchCommand('CAMERA_FEED', { camera: camera.id, enabled: e.detail })}
								/>
							</div>
						{/each}
						<div class="flex items-center justify-between p-2 bg-slate-700 rounded-lg mt-2 border-t border-slate-600 pt-3">
							<span class="font-medium text-sm">Cost Map Feed</span>
							<ToggleSwitch 
								on:change={(e) => dispatchCommand('COST_MAP_FEED', { enabled: e.detail })}
							/>
						</div>
					</div>
				</div>
				<div class="card">
					<div class="p-4 border-b border-slate-700">
						<h2 class="font-semibold text-lg text-white">Individual Wheel Control</h2>
					</div>
					<div class="p-4 grid grid-cols-2 gap-x-4 gap-y-6">
						{#each wheels as wheel}
							<div>
								<h3 class="font-semibold text-sm text-center text-white">{wheel}</h3>
								<label class="block text-xs">Speed: <span>{wheelSpeeds[wheel]}%</span></label>
								<input 
									type="range" 
									class="w-full" 
									bind:value={wheelSpeeds[wheel]}
									on:input={() => dispatchCommand('WHEEL_SPEED', { wheel, speed: wheelSpeeds[wheel] })}
								>
								<label class="block text-xs">Direction: <span>{wheelDirections[wheel]}°</span></label>
								<input 
									type="range" 
									class="w-full" 
									min="-45" 
									max="45" 
									bind:value={wheelDirections[wheel]}
									on:input={() => dispatchCommand('WHEEL_DIRECTION', { wheel, direction: wheelDirections[wheel] })}
								>
							</div>
						{/each}
					</div>
				</div>
			</div>

		</main>
	</div>
</div>

{#if showAutoModal}
	<Modal bind:show={showAutoModal} title="Switch to Autonomous Mode">
		<p class="text-slate-400 mb-6">
			Enter the destination GPS coordinates to begin the autonomous journey. The rover will calculate the optimal path.
		</p>
		<div class="space-y-4">
			<div>
				<label for="gps-lat" class="block text-sm font-medium mb-1">Destination Latitude</label>
				<input 
					id="gps-lat" 
					type="text" 
					class="w-full bg-slate-700 border border-slate-600 rounded-md p-2 text-white" 
					placeholder="e.g., 18.4521° S"
				>
			</div>
			<div>
				<label for="gps-lon" class="block text-sm font-medium mb-1">Destination Longitude</label>
				<input 
					id="gps-lon" 
					type="text" 
					class="w-full bg-slate-700 border border-slate-600 rounded-md p-2 text-white" 
					placeholder="e.g., 77.3663° E"
				>
			</div>
		</div>
		<div class="mt-8 flex justify-end gap-4">
			<button class="btn btn-secondary" on:click={() => showAutoModal = false}>Cancel</button>
			<button 
				class="btn btn-primary"
				on:click={() => {
					const lat = document.getElementById('gps-lat').value;
					const lon = document.getElementById('gps-lon').value;
					initiateAutonomous(lat, lon);
				}}
			>
				Initiate Autonomous Mode
			</button>
		</div>
	</Modal>
{/if}

<style>
	:global(.card) {
		background: linear-gradient(145deg, #222e42, #1a2436);
		border: 1px solid var(--slate-700);
		border-radius: 0.75rem;
		box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.2), 0 4px 6px -4px rgb(0 0 0 / 0.1);
	}

	:global(.btn) {
		display: inline-flex;
		align-items: center;
		justify-content: center;
		padding: 0.5rem 1rem;
		border-radius: 0.5rem;
		font-weight: 600;
		transition: all 0.2s ease;
		border: 1px solid transparent;
	}
	
	:global(.btn:hover) {
		transform: translateY(-2px);
	}

	:global(.btn-primary) {
		background-color: var(--sky-500);
		color: white;
		border-color: var(--sky-500);
	}

	:global(.btn-primary:hover) {
		background-color: var(--sky-400);
		box-shadow: 0 0 15px rgba(56, 189, 248, 0.4);
	}

	:global(.btn-secondary) {
		background-color: var(--slate-700);
		color: var(--slate-300);
		border-color: var(--slate-600);
	}
	
	:global(.btn-secondary:hover) {
		background-color: var(--slate-600);
		border-color: var(--slate-500);
		box-shadow: 0 0 15px rgba(100, 116, 139, 0.3);
	}
</style>
